name: ðŸ§¹ Pull request

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  syntax_changelog:
    name: Syntax & changelog
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - uses: actions/setup-node@v3
        with:
          node-version-file: .nvmrc

      - name: Install
        run: node common/scripts/install-run-rush.js install

      - name: ðŸ— Build
        run: node common/scripts/install-run-rush.js rebuild

      - name: ðŸ“ Verify missing changelogs
        run: node common/scripts/install-run-rush.js change --target-branch origin/$GITHUB_BASE_REF --verify -v

      - name: ðŸ’… Lint
        # --verbose allows to display warnings from ESLint
        run: node common/scripts/install-run-rush.js lint --verbose

  test:
    name: Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node_version: [18, 19, 20]
    outputs:
      module_names: ${{ steps.list_directories.outputs.module_names }}

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node_version }}

      - name: Install
        run: node common/scripts/install-run-rush.js install

      - name: ðŸ— Build
        run: node common/scripts/install-run-rush.js rebuild

      - name: ðŸ› Test
        # use --coverage option to generate coverage reports for their upload in the next job
        run: node common/scripts/install-run-rush.js test --coverage

      - name: Archive code coverage reports
        uses: actions/upload-artifact@v3
        with:
          name: code-coverage-reports
          path: ./modules/*/coverage/*.xml
          retention-days: 1

      - name: List module names for which a coverage report has been generated
        id: list_directories
        run: >
          directories_names=$(find ./modules -name coverage)
          module_names=()
          for directory_name in $directories_names; do module_names+=$(cut -d / -f 3 <<< $directory_name); done
          echo "module_names=$module_names" >> "$GITHUB_OUTPUT"

  upload_coverage_reports:
    strategy:
      matrix:
        module_name: ${{ needs.test.outputs.module_names }}
    uses: ./.github/workflows/upload_coverage_report.yaml
    with:
      module_name: ${{ matrix.module_name }}
